<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ne YapÄ±lmalÄ± - Vestel Karar Destek Sistemi</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <img src="/images/vestel-logo.png" alt="VESTEL" class="vestel-logo" onerror="this.style.display='none'">
                <h1>Vestel Karar Destek Sistemi</h1>
            </div>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/departments">Departmanlar</a>
                <a href="/what-to-do" class="active">Ne YapÄ±lmalÄ±</a>
                <a href="/anomalies">Anormallikler</a>
                <a href="/suggestions">Ã–neriler</a>
                <a href="/scenarios">Senaryo Analizi</a>
            </nav>
        </header>

        <main>
            <!-- 2. ANLAMLANDIRMA: Bu tÃ¼ketim normal mi? -->
            <section class="section">
                <h2>âš ï¸ AnlamlandÄ±rma: Bu TÃ¼ketim Normal Mi?</h2>
                <p class="section-description">Ã–nceki aya gÃ¶re deÄŸiÅŸimler ve anormallik durumu</p>
                
                <!-- Anormallikler ve DeÄŸiÅŸimler - Departman BazÄ±nda GruplandÄ±rÄ±lmÄ±ÅŸ -->
                <div class="anomalies-grid" id="anomaliesGrid">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </section>

            <!-- 3. KARAR ÃœRETME: Ne yapmalÄ±yÄ±m? -->
            <section class="section">
                <h2>ğŸ’¡ Karar Ãœretme: Ne YapmalÄ±yÄ±m?</h2>
                <p class="section-description">Tasarruf Ã¶nerileri, beklenen kazanÃ§lar ve senaryo karÅŸÄ±laÅŸtÄ±rmasÄ±</p>
                
                <!-- Tasarruf Ã–nerileri KartlarÄ± -->
                <div class="suggestions-grid" id="suggestionsGrid">
                    <!-- JavaScript ile doldurulacak -->
                </div>
            </section>

            <!-- Anormallikler Tablosu -->
            <section class="section">
                <h2>ğŸ“‹ Son Anormallikler</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Departman</th>
                                <th>Enerji TÃ¼rÃ¼</th>
                                <th>Seviye</th>
                                <th>Neden</th>
                                <th>Tarih</th>
                                <th>TÃ¼ketim (kWh)</th>
                                <th>Maliyet (TL)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (anomalies && anomalies.length > 0) { %>
                                <% anomalies.forEach(anomaly => { %>
                                    <tr class="anomaly-<%= anomaly.anomaly_level %>">
                                        <td><%= anomaly.department_name %></td>
                                        <td><%= anomaly.energy_name %></td>
                                        <td><span class="badge badge-<%= anomaly.anomaly_level %>"><%= anomaly.anomaly_level %></span></td>
                                        <td><%= anomaly.anomaly_reason %></td>
                                        <td><%= new Date(anomaly.detected_at).toLocaleDateString('tr-TR') %></td>
                                        <td><%= parseFloat(anomaly.consumption_kwh).toLocaleString('tr-TR') %></td>
                                        <td><%= parseFloat(anomaly.cost).toLocaleString('tr-TR') %></td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="7" class="no-data">Anormallik bulunamadÄ±</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Ã–neriler Tablosu -->
            <section class="section">
                <h2>ğŸ’¡ Enerji Tasarrufu Ã–nerileri</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Departman</th>
                                <th>BaÅŸlÄ±k</th>
                                <th>Beklenen Tasarruf (kWh)</th>
                                <th>Beklenen Tasarruf (TL)</th>
                                <th>COâ‚‚ AzaltÄ±mÄ± (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (suggestions && suggestions.length > 0) { %>
                                <% suggestions.forEach(suggestion => { %>
                                    <tr>
                                        <td><%= suggestion.department_name %></td>
                                        <td><%= suggestion.title %></td>
                                        <td><%= parseFloat(suggestion.expected_saving_kwh || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                        <td><%= parseFloat(suggestion.expected_saving_tl || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                        <td><%= parseFloat(suggestion.expected_saving_co2_kg || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="5" class="no-data">Ã–neri bulunamadÄ±</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Anormallikleri render et - Departman bazÄ±nda gruplandÄ±rÄ±lmÄ±ÅŸ
        function renderAnomalies() {
            const container = document.getElementById('anomaliesGrid');
            if (!container) return;

            <% if (anomalies && anomalies.length > 0) { %>
                const anomaliesData = <%- JSON.stringify(anomalies) %>;
                
                // Departman bazÄ±nda grupla
                const deptMap = new Map();
                
                anomaliesData.forEach(anomaly => {
                    const deptName = anomaly.department_name || 'Bilinmeyen';
                    if (!deptMap.has(deptName)) {
                        deptMap.set(deptName, {
                            department_name: deptName,
                            anomalies: [],
                            highCount: 0,
                            mediumCount: 0,
                            lowCount: 0
                        });
                    }
                    const dept = deptMap.get(deptName);
                    dept.anomalies.push(anomaly);
                    
                    // Seviye sayÄ±larÄ±nÄ± gÃ¼ncelle
                    if (anomaly.anomaly_level === 'high') dept.highCount++;
                    else if (anomaly.anomaly_level === 'medium') dept.mediumCount++;
                    else if (anomaly.anomaly_level === 'low') dept.lowCount++;
                });
                
                // DepartmanlarÄ± toplam anormallik sayÄ±sÄ±na gÃ¶re sÄ±rala (yÃ¼ksekten dÃ¼ÅŸÃ¼ÄŸe)
                const departments = Array.from(deptMap.values())
                    .sort((a, b) => (b.highCount * 3 + b.mediumCount * 2 + b.lowCount) - (a.highCount * 3 + a.mediumCount * 2 + a.lowCount));
                
                const levelNames = {
                    'high': 'YÃ¼ksek',
                    'medium': 'Orta',
                    'low': 'DÃ¼ÅŸÃ¼k'
                };
                
                let html = '';
                
                // Her departman iÃ§in bir bÃ¶lÃ¼m oluÅŸtur
                departments.forEach((dept, deptIndex) => {
                    const totalAnomalies = dept.anomalies.length;
                    const isExpanded = deptIndex === 0; // Ä°lk departman varsayÄ±lan olarak aÃ§Ä±k
                    
                    html += `
                        <div class="anomaly-department-group" data-dept-index="${deptIndex}">
                            <div class="department-group-header" onclick="toggleDepartmentGroup(${deptIndex})">
                                <div class="department-header-left">
                                    <span class="department-toggle-icon">${isExpanded ? 'â–¼' : 'â–¶'}</span>
                                    <h3 class="department-group-title">${dept.department_name}</h3>
                                </div>
                                <div class="department-group-stats">
                                    ${dept.highCount > 0 ? `<span class="stat-item stat-high">${dept.highCount} YÃ¼ksek</span>` : ''}
                                    ${dept.mediumCount > 0 ? `<span class="stat-item stat-medium">${dept.mediumCount} Orta</span>` : ''}
                                    ${dept.lowCount > 0 ? `<span class="stat-item stat-low">${dept.lowCount} DÃ¼ÅŸÃ¼k</span>` : ''}
                                    <span class="stat-item stat-total">${totalAnomalies} Anormallik</span>
                                </div>
                            </div>
                            <div class="anomalies-grid-department ${isExpanded ? 'expanded' : 'collapsed'}" id="dept-group-${deptIndex}">
                    `;
                    
                    // Bu departmana ait anormallik kartlarÄ±nÄ± ekle
                    dept.anomalies.forEach(anomaly => {
                        const levelClass = `anomaly-${anomaly.anomaly_level}`;
                        
                        html += `
                            <div class="anomaly-card ${levelClass}">
                                <div class="anomaly-header">
                                    <div class="anomaly-energy-type">
                                        <span class="energy-icon">âš¡</span>
                                        <span class="energy-name">${anomaly.energy_name || 'Enerji TÃ¼rÃ¼'}</span>
                                    </div>
                                    <span class="badge badge-${anomaly.anomaly_level}">${levelNames[anomaly.anomaly_level] || anomaly.anomaly_level}</span>
                                </div>
                                <div class="anomaly-reason">
                                    <strong>ğŸ” Neden:</strong> ${anomaly.anomaly_reason || 'BelirtilmemiÅŸ'}
                                </div>
                                <div class="anomaly-details">
                                    <div class="detail-row">
                                        <span class="detail-label">ğŸ“Š TÃ¼ketim:</span>
                                        <span class="detail-value">${parseFloat(anomaly.consumption_kwh || 0).toLocaleString('tr-TR')} kWh</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">ğŸ’° Maliyet:</span>
                                        <span class="detail-value">${parseFloat(anomaly.cost || 0).toLocaleString('tr-TR')} TL</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">ğŸ“… Tarih:</span>
                                        <span class="detail-value">${new Date(anomaly.detected_at).toLocaleDateString('tr-TR')}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            <% } else { %>
                container.innerHTML = '<div class="no-data">Anormallik bulunamadÄ±</div>';
            <% } %>
        }

        // Ã–nerileri render et
        function renderSuggestions() {
            const container = document.getElementById('suggestionsGrid');
            if (!container) return;

            <% if (suggestions && suggestions.length > 0) { %>
                const suggestionsData = <%- JSON.stringify(suggestions) %>;
                
                let html = '';
                suggestionsData.slice(0, 12).forEach(suggestion => {
                    // AÃ§Ä±klama oluÅŸtur - Ã¶nce description/suggestion_text, yoksa title'dan anlamlÄ± bir aÃ§Ä±klama
                    let descriptionText = suggestion.description || suggestion.suggestion_text || '';
                    
                    // EÄŸer aÃ§Ä±klama yoksa, title'a gÃ¶re aÃ§Ä±klama oluÅŸtur
                    if (!descriptionText || descriptionText.trim() === '') {
                        const title = (suggestion.title || '').toLowerCase();
                        const deptName = suggestion.department_name || 'Bu departmanda';
                        
                        if (title.includes('acil') || title.includes('yÃ¼ksek artÄ±ÅŸ')) {
                            descriptionText = `${deptName} enerji tÃ¼ketiminde ciddi bir artÄ±ÅŸ tespit edildi. Acilen tÃ¼ketim kontrolÃ¼ yapÄ±lmalÄ± ve enerji verimliliÄŸi Ã¶nlemleri uygulanmalÄ±dÄ±r.`;
                        } else if (title.includes('artÄ±ÅŸ') || title.includes('orta')) {
                            descriptionText = `${deptName} enerji tÃ¼ketiminde orta seviyede bir artÄ±ÅŸ gÃ¶zlemlendi. TÃ¼ketim kalÄ±plarÄ± gÃ¶zden geÃ§irilmeli ve iyileÅŸtirme fÄ±rsatlarÄ± deÄŸerlendirilmelidir.`;
                        } else if (title.includes('verimlilik') || title.includes('optimizasyon')) {
                            descriptionText = `${deptName} enerji verimliliÄŸini artÄ±rmak iÃ§in optimizasyon Ã§alÄ±ÅŸmalarÄ± yapÄ±lmalÄ±dÄ±r. Mevcut ekipmanlarÄ±n verimliliÄŸi kontrol edilmeli ve gerekirse modernizasyon dÃ¼ÅŸÃ¼nÃ¼lmelidir.`;
                        } else if (title.includes('kontrol') || title.includes('izleme')) {
                            descriptionText = `${deptName} enerji tÃ¼ketiminin dÃ¼zenli olarak izlenmesi ve kontrol edilmesi gerekmektedir. Anormal tÃ¼ketim durumlarÄ± iÃ§in alarm sistemleri kurulmalÄ±dÄ±r.`;
                        } else if (title.includes('bakÄ±m')) {
                            descriptionText = `${deptName} enerji ekipmanlarÄ±nÄ±n periyodik bakÄ±mÄ± yapÄ±lmalÄ±dÄ±r. BakÄ±mÄ± geciken ekipmanlar enerji verimliliÄŸini dÃ¼ÅŸÃ¼rebilir.`;
                        } else {
                            descriptionText = `${deptName} enerji tÃ¼ketimini optimize etmek iÃ§in gerekli Ã¶nlemler alÄ±nmalÄ±dÄ±r. Enerji yÃ¶netimi stratejileri gÃ¶zden geÃ§irilmeli ve uygulanmalÄ±dÄ±r.`;
                        }
                    }
                    
                    html += `
                        <div class="suggestion-card">
                            <div class="suggestion-header">
                                <h3>${suggestion.title || 'Ã–neri'}</h3>
                                <span class="badge badge-success">Ã–neri</span>
                            </div>
                            <p class="suggestion-text">${descriptionText}</p>
                            <div class="suggestion-details">
                                <div><strong>Departman:</strong> ${suggestion.department_name || 'Genel'}</div>
                                <div><strong>YÄ±llÄ±k Tasarruf:</strong> ${parseFloat(suggestion.expected_saving_tl || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} TL</div>
                                <div><strong>COâ‚‚ AzaltÄ±mÄ±:</strong> ${parseFloat(suggestion.expected_saving_co2_kg || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kg/yÄ±l</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            <% } else { %>
                container.innerHTML = '<div class="no-data">Ã–neri bulunamadÄ±</div>';
            <% } %>
        }

        // Departman grubunu aÃ§/kapa
        function toggleDepartmentGroup(index) {
            const group = document.getElementById(`dept-group-${index}`);
            const header = document.querySelector(`[data-dept-index="${index}"] .department-group-header`);
            const icon = header.querySelector('.department-toggle-icon');
            
            if (group.classList.contains('collapsed')) {
                group.classList.remove('collapsed');
                group.classList.add('expanded');
                icon.textContent = 'â–¼';
            } else {
                group.classList.remove('expanded');
                group.classList.add('collapsed');
                icon.textContent = 'â–¶';
            }
        }
        
        // Global function olarak tanÄ±mla
        window.toggleDepartmentGroup = toggleDepartmentGroup;

        // Sayfa yÃ¼klendiÄŸinde render et
        document.addEventListener('DOMContentLoaded', function() {
            renderAnomalies();
            renderSuggestions();
        });
    </script>
</body>
</html>

